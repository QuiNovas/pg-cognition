
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>PgCognition documentation &#8212; PgCognition  documentation</title>
    <link rel="stylesheet" href="_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="#">PgCognition  documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="pgcognition-documentation">
<h1>PgCognition documentation<a class="headerlink" href="#pgcognition-documentation" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
</div>
<div class="section" id="databaseclient">
<h1>DatabaseClient<a class="headerlink" href="#databaseclient" title="Permalink to this headline">¶</a></h1>
<dl class="class">
<dt id="PgCognition.DatabaseClient">
<em class="property">class </em><code class="sig-prename descclassname">PgCognition.</code><code class="sig-name descname">DatabaseClient</code><span class="sig-paren">(</span><em class="sig-param">event=None</em>, <em class="sig-param">config={}</em>, <em class="sig-param">client_type='instance'</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Keyword Arguments</dt>
<dd class="field-odd"><ul class="simple">
<li><p><em>client_type</em> – (<code class="docutils literal notranslate"><span class="pre">str</span></code>) – “serverless” for Aurora Serverless, otherwise “instance”. Defaults to “instance”</p></li>
<li><p><em>event</em> (<code class="docutils literal notranslate"><span class="pre">list</span> <span class="pre">or</span> <span class="pre">dict</span></code>) – event argument from Lambda function</p></li>
<li><dl class="simple">
<dt><em>config</em> (<code class="docutils literal notranslate"><span class="pre">dict</span></code>) – configuration options</dt><dd><ul>
<li><p><em>region</em> – (<code class="docutils literal notranslate"><span class="pre">str</span></code>, optional) aws region. Defaults to us-east-1</p></li>
<li><p><em>database</em> – (<code class="docutils literal notranslate"><span class="pre">str</span></code>) database name</p></li>
<li><p><em>databaseArn</em> – (<code class="docutils literal notranslate"><span class="pre">str</span></code>) arn of the database</p></li>
<li><p><em>databaseSecretArn</em> – (optional) Arn of the database secret to use. Defaults to caller’s secret</p></li>
<li><p><em>account</em> – (optional) Account number where secrets live. Defaults to account number resolved by cognition_functions.getCallerAccount()</p></li>
<li><p><em>secretsPath</em> – (optional) Path to AWS secrets. Defaults to rds-db-credentials/</p></li>
<li><p><em>roleOverrides</em> – (<code class="docutils literal notranslate"><span class="pre">dict</span></code>, optional) a dictionary of {&lt;role arn&gt;: &lt;secret name&gt;} to match for auth</p></li>
<li><p><em>assumedRoleOverrides</em> – (<code class="docutils literal notranslate"><span class="pre">dict</span></code>, optional) a dictionary of {&lt;role name&gt;: &lt;secret name&gt;} to match for auth. Used to auth assumed roles (cli users for instance)</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>An instance of PgCognition.DatabaseClient</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><a class="reference internal" href="#PgCognition.DatabaseClient" title="PgCognition.DatabaseClient">PgCognition.DatabaseClient</a></p>
</dd>
<dt class="field-even">Environment</dt>
<dd class="field-even"><p>Options required in config can be omitted if they exist in os.environ. Options to be taken from the environment should have their names specified in all caps.</p>
</dd>
</dl>
<p><em>Example with a standard Postgres database</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PgCognition</span> <span class="kn">import</span> <span class="n">DatabaseClient</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dbname&quot;</span><span class="p">:</span> <span class="s2">&quot;mydb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;myuser&quot;</span><span class="p">,</span>
    <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;password&quot;</span>
<span class="p">}</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">DatabaseClient</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">client_type</span><span class="o">=</span><span class="s2">&quot;instance&quot;</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">runQuery</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM mytable&quot;</span><span class="p">,</span> <span class="n">switch_role</span><span class="o">=</span><span class="s2">&quot;less_privileged_role&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><em>Example with a Aurora Serverless</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PgCognition</span> <span class="kn">import</span> <span class="n">DatabaseClient</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="s2">&quot;mydb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;account&quot;</span><span class="p">:</span> <span class="mi">12345678</span><span class="p">,</span>
    <span class="s2">&quot;databaseArn&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:rds:us-east-1:123456789:db:mydb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;assumedRoleOverrides&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;administrator&quot;</span><span class="p">:</span> <span class="s2">&quot;root-secret&quot;</span><span class="p">,</span> <span class="s2">&quot;developer&quot;</span><span class="p">:</span> <span class="s2">&quot;root-secret&quot;</span><span class="p">},</span>
    <span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="s2">&quot;us-east-1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;secretsPath&quot;</span><span class="p">:</span> <span class="s2">&quot;rds-db-credentials&quot;</span>
<span class="p">}</span>
<span class="n">dbClient</span> <span class="o">=</span> <span class="n">DatabaseClient</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
<span class="k">return</span> <span class="n">dbClient</span><span class="o">.</span><span class="n">resolveAppsyncQuery</span><span class="p">()</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">runQuery</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM mytable&quot;</span><span class="p">,</span> <span class="n">switch_role</span><span class="o">=</span><span class="s2">&quot;less_privileged_role&quot;</span><span class="p">)</span>
</pre></div>
</div>
<dl class="method">
<dt id="PgCognition.DatabaseClient.cloneSchema">
<code class="sig-name descname">cloneSchema</code><span class="sig-paren">(</span><em class="sig-param">src</em>, <em class="sig-param">dest</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient.cloneSchema" title="Permalink to this definition">¶</a></dt>
<dd><p>Clones a schema with all objects and permissions</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>src</strong> (<em>str</em>) – The source schema to clone</p></li>
<li><p><strong>dest</strong> (<em>str</em>) – The name of the destination schema</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>None</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>None</p>
</dd>
</dl>
<p><em>Example</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PgCognition</span> <span class="kn">import</span> <span class="n">DatabaseClient</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dbname&quot;</span><span class="p">:</span> <span class="s2">&quot;mydb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;myuser&quot;</span><span class="p">,</span>
    <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;password&quot;</span>
<span class="p">}</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">DatabaseClient</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">client_type</span><span class="o">=</span><span class="s2">&quot;instance&quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">cloneSchema</span><span class="p">(</span><span class="s2">&quot;tenant_template&quot;</span><span class="p">,</span> <span class="s2">&quot;new_tenant&quot;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="PgCognition.DatabaseClient.close">
<code class="sig-name descname">close</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient.close" title="Permalink to this definition">¶</a></dt>
<dd><p>Close the database connection for client_type of “instance”</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>None</p>
</dd>
<dt class="field-even">Return type</dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
<p>This will throw an AttributeError if client_type is not “instance”</p>
</dd></dl>

<dl class="method">
<dt id="PgCognition.DatabaseClient.createCognitionUser">
<code class="sig-name descname">createCognitionUser</code><span class="sig-paren">(</span><em class="sig-param">email=None</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient.createCognitionUser" title="Permalink to this definition">¶</a></dt>
<dd><p>Creates a database user that is tied to an application user in cognition.users table. Normally run as part of Cognito’s PostSignup hook.</p>
<dl class="field-list simple">
<dt class="field-odd">Keyword Arguments</dt>
<dd class="field-odd"><ul class="simple">
<li><p><em>email</em> (<code class="docutils literal notranslate"><span class="pre">str</span></code>) – Override the email address from self.event[“user”][“email”]</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>Dictionary containing new user’s database credentials and corresponding user from cognition.users table</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>dict</p>
</dd>
</dl>
<p>This method does not just create a database user/role. It marries a user in the cognition.users table to a new database user. If
the email address passed to the method does not exist in the cognition.users table then an Exception will be raised. If you want to
create arbitrary users use PgCognition.DatabaseClient.createRole method.</p>
</dd></dl>

<dl class="method">
<dt id="PgCognition.DatabaseClient.createRole">
<code class="sig-name descname">createRole</code><span class="sig-paren">(</span><em class="sig-param">role</em>, <em class="sig-param">group='NULL'</em>, <em class="sig-param">password='NULL'</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient.createRole" title="Permalink to this definition">¶</a></dt>
<dd><p>Creates a role, optionally with login, optionally in a group</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>role</strong> (<em>str</em>) – Name of new role</p>
</dd>
<dt class="field-even">Keyword Arguments</dt>
<dd class="field-even"><ul class="simple">
<li><p><em>group</em> (<code class="docutils literal notranslate"><span class="pre">str</span></code>) – Group to add role to</p></li>
<li><p><em>password</em> (<code class="docutils literal notranslate"><span class="pre">str</span></code>) – Give role login privilege with provided password</p></li>
</ul>
</dd>
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>None</p>
</dd>
<dt class="field-even">Return type</dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
<p>If password kwarg is provided then user will have login privileges with provided password, otherwise the role will not have login.
If group kwarg is provided the role will be created inside of that group.</p>
<p><em>Example adding a user role to a tenant for an instance type client</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PgCognition</span> <span class="kn">import</span> <span class="n">DatabaseClient</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dbname&quot;</span><span class="p">:</span> <span class="s2">&quot;mydb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;myuser&quot;</span><span class="p">,</span>
    <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;password&quot;</span>
<span class="p">}</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">DatabaseClient</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">client_type</span><span class="o">=</span><span class="s2">&quot;instance&quot;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">createRole</span><span class="p">(</span><span class="s2">&quot;myuser&quot;</span><span class="p">,</span> <span class="s2">&quot;my_tenant_users&quot;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="PgCognition.DatabaseClient.createSecret">
<code class="sig-name descname">createSecret</code><span class="sig-paren">(</span><em class="sig-param">userid</em>, <em class="sig-param">email</em>, <em class="sig-param">dbpass</em>, <em class="sig-param">upsert=True</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient.createSecret" title="Permalink to this definition">¶</a></dt>
<dd><p>Creates an AWS Secret to use for database credentials</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>userid</strong> (<em>str</em>) – The database username to put in the secret</p></li>
<li><p><strong>email</strong> (<em>str</em>) – The cognito email address for the database user</p></li>
<li><p><strong>dbpass</strong> (<em>str</em>) – Database password to store</p></li>
</ul>
</dd>
<dt class="field-even">Keyword Arguments</dt>
<dd class="field-even"><ul class="simple">
<li><p><em>upsert</em> (<code class="docutils literal notranslate"><span class="pre">bool</span></code>) – If True (default) then update the secret if a secret exists for this email address.</p></li>
</ul>
</dd>
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>ARN of secret</p>
</dd>
<dt class="field-even">Return type</dt>
<dd class="field-even"><p>str</p>
</dd>
</dl>
<p>If upsert=False and a secret already exists for the email address an Exception will be raised.</p>
</dd></dl>

<dl class="method">
<dt id="PgCognition.DatabaseClient.deleteSecret">
<code class="sig-name descname">deleteSecret</code><span class="sig-paren">(</span><em class="sig-param">user</em>, <em class="sig-param">wait=True</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient.deleteSecret" title="Permalink to this definition">¶</a></dt>
<dd><p>Deletes an AWS Secret
:param user:  Email address of the user to remove the secret for
:type user: str</p>
<dl class="field-list simple">
<dt class="field-odd">Keyword Arguments</dt>
<dd class="field-odd"><ul class="simple">
<li><p><em>wait</em> (<code class="docutils literal notranslate"><span class="pre">bool</span></code>) – Block until delete is complete</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="PgCognition.DatabaseClient.getCredentials">
<code class="sig-name descname">getCredentials</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient.getCredentials" title="Permalink to this definition">¶</a></dt>
<dd><p>Get ARN for the secret containing the RDS credentials for the user who called us.</p>
<dl class="simple">
<dt>Secrets for cognito users are constructed as:</dt><dd><p>arn:aws:secretsmanager:{region}:{account}:{secretsPath}/{event[“identity”][“email”]}</p>
</dd>
<dt>We will return the first credential found in the order of:</dt><dd><ol class="arabic simple">
<li><p>If caller is a Cognito user</p></li>
<li><p>If caller is matched in roleOverrides</p></li>
<li><p>If caller is matched in assumedRoleOverrides</p></li>
</ol>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>The arn of an AWS secret</p>
</dd>
<dt class="field-even">Return type</dt>
<dd class="field-even"><p>str</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="PgCognition.DatabaseClient.getTenantRole">
<code class="sig-name descname">getTenantRole</code><span class="sig-paren">(</span><em class="sig-param">email</em>, <em class="sig-param">tenant</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient.getTenantRole" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the role for a Cognito user by email within a specific tenant</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>email</strong> (<em>str</em>) – Email address of user</p></li>
<li><p><strong>tenant</strong> – Name of tenant to retrieve user’s role within</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The user’s role within a tenant</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
<p><em>Example adding a user role to a tenant for an instance type client</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PgCognition</span> <span class="kn">import</span> <span class="n">DatabaseClient</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dbname&quot;</span><span class="p">:</span> <span class="s2">&quot;mydb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;myuser&quot;</span><span class="p">,</span>
    <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;password&quot;</span>
<span class="p">}</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">DatabaseClient</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">client_type</span><span class="o">=</span><span class="s2">&quot;instance&quot;</span><span class="p">)</span>
<span class="n">role</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getTenantRole</span><span class="p">(</span><span class="s2">&quot;myser@foo.com&quot;</span><span class="p">,</span> <span class="s2">&quot;my_tenant&quot;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="PgCognition.DatabaseClient.getTenants">
<code class="sig-name descname">getTenants</code><span class="sig-paren">(</span><em class="sig-param">identifier</em>, <em class="sig-param">identifier_type='email'</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient.getTenants" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the tenants a user belongs to. Either by email, or database role/user</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>identifier</strong> (<em>str</em>) – Email address or database role of user</p>
</dd>
<dt class="field-even">Keyword Arguments</dt>
<dd class="field-even"><ul class="simple">
<li><p><em>identifier_type</em> (<code class="docutils literal notranslate"><span class="pre">str</span></code>) – Cognito email address or “dbuser”</p></li>
</ul>
</dd>
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>The user’s tenants</p>
</dd>
<dt class="field-even">Return type</dt>
<dd class="field-even"><p>list</p>
</dd>
</dl>
<p><em>Example adding a user role to a tenant for an instance type client</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PgCognition</span> <span class="kn">import</span> <span class="n">DatabaseClient</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dbname&quot;</span><span class="p">:</span> <span class="s2">&quot;mydb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;myuser&quot;</span><span class="p">,</span>
    <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;password&quot;</span>
<span class="p">}</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">DatabaseClient</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">client_type</span><span class="o">=</span><span class="s2">&quot;instance&quot;</span><span class="p">)</span>
<span class="n">role</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getTenantRole</span><span class="p">(</span><span class="s2">&quot;myser@foo.com&quot;</span><span class="p">,</span> <span class="s2">&quot;my_tenant&quot;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="PgCognition.DatabaseClient.groupsOf">
<code class="sig-name descname">groupsOf</code><span class="sig-paren">(</span><em class="sig-param">username</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient.groupsOf" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the database groups a database user belongs to</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>user</strong> (<em>str</em>) – Database username</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A list of database groups a database user belongs to</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>list</p>
</dd>
</dl>
<p><em>Example</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PgCognition</span> <span class="kn">import</span> <span class="n">DatabaseClient</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dbname&quot;</span><span class="p">:</span> <span class="s2">&quot;mydb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;myuser&quot;</span><span class="p">,</span>
    <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;password&quot;</span>
<span class="p">}</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">DatabaseClient</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">client_type</span><span class="o">=</span><span class="s2">&quot;instance&quot;</span><span class="p">)</span>
<span class="n">groups</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">groupsOf</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="n">myuserid</span><span class="s2">&quot;)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="PgCognition.DatabaseClient.resolveAppsyncQuery">
<code class="sig-name descname">resolveAppsyncQuery</code><span class="sig-paren">(</span><em class="sig-param">schema=''</em>, <em class="sig-param">secretArn=None</em>, <em class="sig-param">client_type=None</em>, <em class="sig-param">switch_role=None</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient.resolveAppsyncQuery" title="Permalink to this definition">¶</a></dt>
<dd><p>Run a query for each item in event</p>
<p>This is a wrapper for DatabaseClient.resolveInstanceAppsyncQuery and DatabaseClient.resolveServerlessAppsyncQuery and
will return the result of one of these two methods, depending on whether client_type is “serverless” or “instance”.
See PgCognition.DatabaseClient.resolveInstanceAppsyncQuery and PgCognition.DatabaseClient.resolveServerlessAppsyncQuery</p>
<dl class="field-list simple">
<dt class="field-odd">Keyword Arguments</dt>
<dd class="field-odd"><ul class="simple">
<li><p><em>schema</em> (<code class="docutils literal notranslate"><span class="pre">str</span></code>) – Schema name. Boto3 rds-client doesn’t acually honor this right not. It is best to use the full path to your table in your query. Only used if client_type = “serverless”</p></li>
<li><p><em>secretArn</em> (<code class="docutils literal notranslate"><span class="pre">str</span></code>) – Override databaseSecretArn from config. Only used if client_type = “serverless”</p></li>
<li><p><em>switch_role</em> (<code class="docutils literal notranslate"><span class="pre">str</span></code>) – Excute query as specific user. The current connection must use a user with permission to assume this role. Only used if client_type = “instance”</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>Query results from PgCognition.DatabaseClient.resolveInstanceAppsyncQuery or PgCognition.DatabaseClient.resolveServerlessAppsyncQuery</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>dict or list</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="PgCognition.DatabaseClient.resolveInstanceAppsyncQuery">
<code class="sig-name descname">resolveInstanceAppsyncQuery</code><span class="sig-paren">(</span><em class="sig-param">switch_role=None</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient.resolveInstanceAppsyncQuery" title="Permalink to this definition">¶</a></dt>
<dd><p>Run a query for each item in the event.</p>
<dl class="field-list simple">
<dt class="field-odd">Keyword Arguments</dt>
<dd class="field-odd"><ul class="simple">
<li><p><em>switch_role</em> (<code class="docutils literal notranslate"><span class="pre">str</span></code>) – Excute query as specific user. The current connection must use a user with permission to assume this role</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>list of dicts or list of list of dicts with column names as keys</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>list</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="PgCognition.DatabaseClient.resolveServerlessAppsyncQuery">
<code class="sig-name descname">resolveServerlessAppsyncQuery</code><span class="sig-paren">(</span><em class="sig-param">schema=''</em>, <em class="sig-param">secretArn=None</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient.resolveServerlessAppsyncQuery" title="Permalink to this definition">¶</a></dt>
<dd><p>Run a query for each item in the event.</p>
<dl class="field-list simple">
<dt class="field-odd">Keyword Arguments</dt>
<dd class="field-odd"><ul class="simple">
<li><p><em>schema</em> (<code class="docutils literal notranslate"><span class="pre">str</span></code>) – Schema name. Boto3 rds-client doesn’t acually honor this right not. It is best to use the full path to your table in your query.</p></li>
<li><p><em>secretArn</em> (<code class="docutils literal notranslate"><span class="pre">str</span></code>) – Override databaseSecretArn from config</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>list of dicts or list of list of dicts with column names as keys</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>list</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="PgCognition.DatabaseClient.runInstanceQuery">
<code class="sig-name descname">runInstanceQuery</code><span class="sig-paren">(</span><em class="sig-param">sql</em>, <em class="sig-param">**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient.runInstanceQuery" title="Permalink to this definition">¶</a></dt>
<dd><p>Run a query against an Postgresql database</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>sql</strong> (<em>str</em><em>, </em><em>required</em>) – SQL statement to execute</p>
</dd>
<dt class="field-even">Keyword Arguments</dt>
<dd class="field-even"><ul class="simple">
<li><p><em>pretty</em> (<code class="docutils literal notranslate"><span class="pre">bool</span></code>) – format the results as a list of dicts, one per row, with the keys as column names, default True</p></li>
<li><p><em>parameters</em> (<code class="docutils literal notranslate"><span class="pre">list</span></code>) – a list of parameters to pass to the query in psycopg2’s format</p></li>
<li><p><em>switch_role</em> (<code class="docutils literal notranslate"><span class="pre">string</span></code>) – Run “SET ROLE &lt;switch_role&gt;” before executing the query to escalate/deescalate privileges</p></li>
<li><p><em>commit</em> (<code class="docutils literal notranslate"><span class="pre">bool</span></code>) – Commit directly after query</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="PgCognition.DatabaseClient.runQuery">
<code class="sig-name descname">runQuery</code><span class="sig-paren">(</span><em class="sig-param">sql</em>, <em class="sig-param">**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient.runQuery" title="Permalink to this definition">¶</a></dt>
<dd><p>Run an SQL query HELLO</p>
<p>This method is a convenience wrapper for runInstanceQuery and runServerlessQuery
The method called whose return value is returned from this method and whose arguments
should be passed will depend on self.client_type</p>
<p>See PgCognition.DatabaseClient.runInstanceQuery and PgCognition.DatabaseClient.runServerlessQuery for arguments</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>List or Dictionary of query results</p>
</dd>
<dt class="field-even">Return type</dt>
<dd class="field-even"><p>list or dict</p>
</dd>
</dl>
<p><em>Example with a standard Postgres database</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PgCognition</span> <span class="kn">import</span> <span class="n">DatabaseClient</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dbname&quot;</span><span class="p">:</span> <span class="s2">&quot;mydb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;myuser&quot;</span><span class="p">,</span>
    <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;password&quot;</span>
<span class="p">}</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">DatabaseClient</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">client_type</span><span class="o">=</span><span class="s2">&quot;instance&quot;</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">runQuery</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM mytable&quot;</span><span class="p">,</span> <span class="n">switch_role</span><span class="o">=</span><span class="s2">&quot;less_privileged_role&quot;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="PgCognition.DatabaseClient.runServerlessQuery">
<code class="sig-name descname">runServerlessQuery</code><span class="sig-paren">(</span><em class="sig-param">sql</em>, <em class="sig-param">**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.DatabaseClient.runServerlessQuery" title="Permalink to this definition">¶</a></dt>
<dd><p>Run a query against an Aurora Serverless Postgresql database</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>sql</strong> (<em>str</em><em>, </em><em>required</em>) – SQL statement to execute</p>
</dd>
<dt class="field-even">Keyword Arguments</dt>
<dd class="field-even"><ul class="simple">
<li><p><em>schema</em> (<code class="docutils literal notranslate"><span class="pre">str</span></code>) – schema to use. Boto3 does not currently respect this. Use the full path to your table in the query instead</p></li>
<li><p><em>pretty</em> (<code class="docutils literal notranslate"><span class="pre">bool</span></code>) – format the results as a list of dicts, one per row, with the keys as column names, default True</p></li>
<li><p><em>parameters</em> (<code class="docutils literal notranslate"><span class="pre">list</span></code>) – a list of parameters to pass to the query</p></li>
<li><p><em>secret</em> (<code class="docutils literal notranslate"><span class="pre">str</span></code>) – override config[“databaseSecretArn”]</p></li>
<li><p><em>database</em> (<code class="docutils literal notranslate"><span class="pre">str</span></code>) – override config[“database”]</p></li>
<li><p><em>databaseArn</em> (<code class="docutils literal notranslate"><span class="pre">str</span></code>) – override config[“databaseArn”]</p></li>
</ul>
</dd>
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>AWS Aurora rds-data response, optionally formatted with auroraPrettyParser</p>
</dd>
<dt class="field-even">Return type</dt>
<dd class="field-even"><p>list or dict</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="cognito">
<h1>Cognito<a class="headerlink" href="#cognito" title="Permalink to this headline">¶</a></h1>
<dl class="class">
<dt id="PgCognition.Cognito">
<em class="property">class </em><code class="sig-prename descclassname">PgCognition.</code><code class="sig-name descname">Cognito</code><span class="sig-paren">(</span><em class="sig-param">event=None</em>, <em class="sig-param">config=None</em>, <em class="sig-param">dbClient=None</em>, <em class="sig-param">client_type='instance'</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.Cognito" title="Permalink to this definition">¶</a></dt>
<dd><p>Methods useful in building cognito hooks</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>config</strong> (<em>dict</em><em>, </em><em>optional</em>) – A database configuration suitable to be passed to DatabaseClient()</p></li>
<li><p><strong>dbCLient</strong> (<a class="reference internal" href="#PgCognition.DatabaseClient" title="PgCognition.DatabaseClient"><em>PgCognition.DatabaseClient</em></a><em>, </em><em>optional</em>) – An instance of DatabaseClient that will be used for queries</p></li>
<li><p><strong>event</strong> (<em>dict</em><em> or </em><em>list</em><em>, </em><em>optional</em>) – AWS Lambda event</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>An instance of Cognito()</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><a class="reference internal" href="#PgCognition.Cognito" title="PgCognition.Cognito">PgCognition.Cognito</a></p>
</dd>
</dl>
<p>You can only pass one of config or dbClient. dbClient must be a configured instance of DatabaseClient. If using DatabaseClient then event can be omitted and dbClient.event will be used, otherwise dbClient.event will be replaced with self.event</p>
<dl class="method">
<dt id="PgCognition.Cognito.AddClaims">
<code class="sig-name descname">AddClaims</code><span class="sig-paren">(</span><em class="sig-param">extraClaims={}</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.Cognito.AddClaims" title="Permalink to this definition">¶</a></dt>
<dd><p>Adds claims to Cognito user and returns the object’s event. Intended to be used with Cognito Pre Token Generation.
Default is to add role and tenant.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>extraClaims</strong> (<em>dict</em><em>, </em><em>optional</em>) – Extra claims to add to jwt</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>self.event updated with claims</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>dict</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="PgCognition.Cognito.UserIsActive">
<code class="sig-name descname">UserIsActive</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.Cognito.UserIsActive" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a bool indicating if a user exists and is active.
Useful for Cognito Pre Authentication hook</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>bool indicating if user is in active state</p>
</dd>
<dt class="field-even">Return type</dt>
<dd class="field-even"><p>bool</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="PgCognition.Cognito.UserIsInvited">
<code class="sig-name descname">UserIsInvited</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.Cognito.UserIsInvited" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a bool indicating if a user has been invited or not</p>
<p>If called by Cognito Post Signup then DatabaseClient.createDatabaseUser({“user”: user})
can be called afterward to create the user in the database. If using AWS Lambda then the
Lambda function that calls createDatabaseUser() should be invoked async after this method
since it can take longer than the 5 timeout that applies to Cognito hooks.</p>
<p>If called by Cognito Pre Signup then we will simply prove that a user has been invited
before continuing with the signup process.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>bool indicating if a user has been invited</p>
</dd>
<dt class="field-even">Return type</dt>
<dd class="field-even"><p>bool</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-PgCognition.cognition_functions">
<span id="cognition-functions"></span><h1>cognition_functions<a class="headerlink" href="#module-PgCognition.cognition_functions" title="Permalink to this headline">¶</a></h1>
<dl class="function">
<dt id="PgCognition.cognition_functions.getCallerAccount">
<code class="sig-prename descclassname">PgCognition.cognition_functions.</code><code class="sig-name descname">getCallerAccount</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.cognition_functions.getCallerAccount" title="Permalink to this definition">¶</a></dt>
<dd><p>Gets account number of entity that called the function using sts service</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>Account number</p>
</dd>
<dt class="field-even">Return type</dt>
<dd class="field-even"><p>str</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="PgCognition.cognition_functions.validateConfig">
<code class="sig-prename descclassname">PgCognition.cognition_functions.</code><code class="sig-name descname">validateConfig</code><span class="sig-paren">(</span><em class="sig-param">requiredOpts</em>, <em class="sig-param">config</em>, <em class="sig-param">defaults={}</em><span class="sig-paren">)</span><a class="headerlink" href="#PgCognition.cognition_functions.validateConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Validate the config has all of the required values. For each required value if the option is not set in the config we will attempt to pull it from the environment before throwing an Exception.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>requiredOpts</strong> (<em>list</em><em>, </em><em>required</em>) – A list of required parameters</p></li>
<li><p><strong>config</strong> (<em>dict</em><em>, </em><em>required</em>) – A dictionary of configuration options</p></li>
<li><p><strong>defaults</strong> (<em>dict</em><em>, </em><em>optional</em>) – A dictionary of config options and their defaults to use if missing</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>Dictionary of configuration options</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>dict</p>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">PgCognition documentation</a></li>
<li><a class="reference internal" href="#databaseclient">DatabaseClient</a></li>
<li><a class="reference internal" href="#cognito">Cognito</a></li>
<li><a class="reference internal" href="#module-PgCognition.cognition_functions">cognition_functions</a></li>
<li><a class="reference internal" href="#indices-and-tables">Indices and tables</a></li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/index.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="#">PgCognition  documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Mathew Moon.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
  </body>
</html>